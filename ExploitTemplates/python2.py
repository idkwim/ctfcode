#!/usr/bin/env python
#coding: UTF-8

import struct
import time
import sys
import select
import socket

TARGET = ('127.0.0.1', 4444)

#
# Helper Functions
#
def p(d, fmt='<I'):
    return struct.pack(fmt, d)

def u(d, fmt='<I'):
    return struct.unpack(fmt, d)

def u1(d, fmt='<I'):
    return u(d, fmt)[0]

#
# Networking
#
remote = None
def connect(server):
    global remote
    remote = socket.create_connection(server)

    # Disable kernel TCP buffering
    remote.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)

    # Enable timeout mode
    remote.settimeout(1)

def recv(bufsize=4096, timeout=.1):
    available, _, _ = select.select([remote], [], [], timeout)
    if (available):
        return remote.recv(bufsize)
    else:
        return b''

def send(data):
    remote.sendall(data)

def eat():
    failcount = 0
    while failcount < 5:
        if len(recv()) == 0:
            failcount += 1
        else:
            failcount = 0

def interact():
    while True:
        sys.stdout.write(recv())
        available, _, _ = select.select([sys.stdin], [], [], .1)
        if (available):
            data = sys.stdin.readline()
            send(data)


#
# Exploit code
#
# Server is just "nc -k -v -e /bin/sh -l 0.0.0.0 4444"
connect(TARGET)
interact()
